<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Krizma Education System â€” Simple Version (Students + Absent Right Column)</title>

  <!-- Tailwind CDN -->
  <script>
    tailwind = window.tailwind || {};
    tailwind.config = { theme: { extend: { fontFamily: { sans: ['Quicksand','sans-serif'], hand: ['Patrick Hand','cursive'] } } } };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Quicksand:wght@300..700&display=swap" rel="stylesheet">

  <!-- html2canvas -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    .font-hand { font-family: 'Patrick Hand', cursive; }

    /* PRINT: only #sheet */
    @media print {
      html, body {
        background: white !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        margin: 0;
        padding: 0;
      }
      body * { visibility: hidden !important; -webkit-print-color-adjust: exact !important; }
      #sheet, #sheet * { visibility: visible !important; }
      #sheet { position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; box-shadow: none !important; }
      .no-print, .no-print * { display: none !important; }
      @page { margin: 8mm; }
    }

    .clone-textarea-fallback { min-height: 80px; white-space: pre-wrap; }
    .school-title-up { margin-top: -8px; }
    .subject-header-tight { padding-top: 6px; padding-bottom: 6px; }
    .city-name-lg { font-size: 0.95rem; font-weight: 600; }

    /* Updated Date Box */
    .date-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding-left: 12px;
      padding-right: 12px;
      padding-top: 10px;
      padding-bottom: 10px;
      min-height: 64px;
      gap: 4px;
    }
    .date-week { opacity: 0.88; margin-top: 0; }

    /* Header tweaks to avoid overlap and keep vertical rhythm */
    .header-left { display: flex; align-items: center; gap: 1rem; }
    .logo-frame { width: 88px; height: 88px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .logo-frame img { width: 72px; height: 72px; border-radius: 50%; object-fit: contain; display:block; }

    /* Make sure header content doesn't overflow on smaller screens */
    @media (max-width: 880px) {
      .logo-frame { width: 68px; height: 68px; }
      .logo-frame img { width: 56px; height: 56px; }
      .school-title-up { margin-top: -4px; font-size: 1.5rem; }
      .city-name-lg { font-size: 0.9rem; }
      .date-box { min-height: 56px; padding: 8px; }
    }

    /* Students area styles */
    .students-box thead th { font-size: 0.85rem; }
    .students-box tbody td { font-size: 0.95rem; vertical-align: top; padding-top: 0.5rem; }
    .absent-box .header { padding: 10px 14px; }
    .absent-box .body { padding: 12px; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <div class="min-h-screen flex flex-col lg:flex-row">
    <!-- EDITOR -->
    <div id="editor" class="w-full lg:w-1/3 bg-white border-r p-6 overflow-auto">
      <div class="flex items-center gap-2 mb-6 text-blue-600">
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/></svg>
        <h2 class="text-2xl font-bold">Krizma Diary</h2>
      </div>

      <div class="space-y-6">
        <div class="p-4 border rounded-lg">
          <h3 class="font-bold mb-3 flex items-center gap-2">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m4 6 8-4 8 4"/><circle cx="12" cy="9" r="2"/></svg>
            Class Details
          </h3>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm block mb-1">Class</label>
              <input id="classInput" class="w-full rounded-md border px-3 py-2 text-sm" value="Nursery" />
            </div>
            <div>
              <label class="text-sm block mb-1">Section</label>
              <input id="sectionInput" class="w-full rounded-md border px-3 py-2 text-sm" value="Section A" />
            </div>
          </div>

          <!-- Teacher name only -->
          <div class="mt-4 grid grid-cols-1 gap-3">
            <label class="text-sm block mb-1 font-bold">Teacher</label>
            <input id="teacherNameInput" class="w-full rounded-md border px-3 py-2 text-sm" placeholder="Teacher Name" value="Miss. Memoona" />
          </div>
        </div>

        <div>
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-bold">Subjects</h3>
            <button id="addSubjectBtn" class="inline-flex items-center gap-2 px-3 py-2 rounded bg-white border text-blue-600">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add
            </button>
          </div>

          <div id="subjectsList" class="space-y-4"></div>
        </div>

        <!-- Students editor -->
        <div>
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-bold">Students</h3>
            <button id="addStudentBtn" class="inline-flex items-center gap-2 px-3 py-2 rounded bg-white border text-blue-600">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add Student
            </button>
          </div>

          <div id="studentsList" class="space-y-3"></div>
        </div>

      </div>
    </div>

    <!-- PREVIEW -->
    <div class="flex-1 p-6 flex flex-col items-center">
      <div class="w-full max-w-6xl flex justify-between items-center mb-6 no-print">
        <h3 class="text-lg font-bold flex items-center gap-2">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="7" rx="1"/></svg>
          Live Preview
        </h3>
        <div class="flex gap-3">
          <button id="saveImageBtn" class="inline-flex items-center gap-2 px-3 py-2 rounded border bg-white">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
            Save Image
          </button>
          <button onclick="window.print()" class="px-3 py-2 rounded bg-blue-600 text-white">Print</button>
        </div>
      </div>

      <div id="sheet" class="w-full max-w-[210mm] bg-white shadow-xl p-6">
        <!-- HEADER -->
        <header class="relative overflow-hidden bg-gradient-to-r from-sky-500 via-blue-500 to-amber-400 text-white p-4 rounded">
          <div class="flex items-center justify-between">
            <!-- left: logo + name -->
            <div class="header-left">
              <div class="logo-frame" aria-hidden="true">
                <img id="logoImg"
                     src="krizma_circle_256.png"
                     alt="Krizma Logo"
                     onerror="this.onerror=null; this.src='logo.png'; this.style.borderRadius='50%';"
                />
              </div>

              <div>
                <h1 id="schoolName" class="text-3xl md:text-4xl font-bold text-white school-title-up leading-tight">KRIZMA Education System</h1>
                <div class="flex items-center gap-2 text-white mt-2">
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m4 6 8-4 8 4"/></svg>
                  <span id="cityName" class="city-name-lg">Dera Ismail Khan</span>
                  <span class="opacity-60">|</span>
                  <span id="headerSpacer" class="opacity-0">placeholder</span>
                </div>
              </div>
            </div>

            <!-- right: date box -->
            <div id="dateBox" class="date-box bg-sky-100 text-blue-900 rounded-xl shadow border border-sky-200">
              <div class="text-xs uppercase font-bold tracking-wider">Date</div>
              <div id="dateFull" class="text-xl font-bold leading-tight">Jan 1, 2025</div>
              <div id="dateWeek" class="text-sm date-week">Wednesday</div>
            </div>
          </div>
        </header>

        <!-- NEW ROW BELOW HEADER: class badge on left + teacher name on right -->
        <div class="mt-4 flex items-start justify-between gap-4">
          <!-- LEFT: Class badge -->
          <div class="flex items-center gap-2">
            <span id="classBadge" class="bg-orange-100 text-red-600 px-3 py-1 rounded text-sm font-bold border border-orange-200">Nursery (Section A)</span>
          </div>

          <!-- RIGHT: Teacher name only -->
          <div id="teacherCard" class="flex items-center gap-3">
            <div class="text-right">
              <div class="text-xs text-gray-600 uppercase">Teacher</div>
              <div id="teacherNamePreview" class="font-bold text-sm">Mrs. Memoona Khan</div>
            </div>
          </div>
        </div>

        <!-- SUBJECTS GRID -->
        <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6" id="previewGrid">
        </main>

        <!-- LOWER ROW: students table (left) + absent box (right) -->
        <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
          <!-- left: students table spans 2 cols on lg -->
          <div class="lg:col-span-2">
            <section>
              <div class="border rounded-xl overflow-hidden students-box">
                <div class="px-4 py-3 bg-blue-50 border-b border-blue-100"> 
                  <div class="grid grid-cols-3 gap-2 items-center"> 
                    <div class="font-bold text-blue-800">Student</div> 
                    <div class="font-bold text-blue-800 text-center">No Copies</div> 
                    <div class="font-bold text-blue-800 text-right">No Diaries</div> 
                  </div>
                </div>

                <div class="p-3">
                  <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                      <tbody id="studentsPreviewBody">
                        <!-- rows filled by JS -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </section>
          </div>

          <!-- right: single Absent box -->
          <div>
            <section class="absent-box">
              <div class="border rounded-xl overflow-hidden">
                <div class="header bg-green-300 text-black rounded-tl-xl rounded-tr-xl font-bold">Absent</div>
                <div class="body bg-amber-50">
                  
                  <div id="absentList" class="px-3 pb-3 font-hand text-sm" style="min-height:3rem"><!-- names go here --></div>
                </div>
              </div>
            </section>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
(function(){
  const palette = [
    { color: 'bg-blue-500 text-white', light: 'bg-blue-50' },
    { color: 'bg-emerald-500 text-white', light: 'bg-emerald-50' },
    { color: 'bg-rose-500 text-white', light: 'bg-rose-50' },
    { color: 'bg-teal-600 text-white', light: 'bg-teal-50' },
    { color: 'bg-violet-500 text-white', light: 'bg-violet-50' },
    { color: 'bg-amber-500 text-white', light: 'bg-amber-50' },
    { color: 'bg-pink-500 text-white', light: 'bg-pink-50' }
  ];

  let subjects = [
    { id: 'english', name: 'English', icon: 'ðŸ“˜', ...palette[0], content: '' },
    { id: 'urdu', name: 'Urdu', icon: 'ðŸ“—', ...palette[1], content: '' },
    { id: 'math', name: 'Mathematics', icon: 'ðŸ§®', ...palette[2], content: '' },
    { id: 'quran', name: 'Quran', icon: 'ðŸŒ™', ...palette[3], content: '' },
    { id: 'spoken', name: 'Spoken', icon: 'ðŸŽ¤', ...palette[4], content: '' },
    { id: 'gk', name: 'General Knowledge', icon: 'ðŸ§ ', ...palette[5], content: '' },
    { id: 'activity', name: 'Activity', icon: 'ðŸŽ¨', ...palette[6], content: '' }
  ];

  // students array: name + optional notes for copies/diary + absent flag
  let students = [
    { id: 'st1', name: 'Ahmed', noCopiesNote: 'Math, English', noDiariesNote: '', absent: true },
    { id: 'st2', name: 'Basit', noCopiesNote: '', noDiariesNote: 'NO', absent: false },
    { id: 'st3', name: 'Nayab', noCopiesNote: '', noDiariesNote: '', absent: true }
  ];

  const subjectsList = document.getElementById('subjectsList');
  const previewGrid = document.getElementById('previewGrid');
  const classInput = document.getElementById('classInput');
  const sectionInput = document.getElementById('sectionInput');
  const classBadge = document.getElementById('classBadge');
  const dateFull = document.getElementById('dateFull');
  const dateWeek = document.getElementById('dateWeek');
  const saveImageBtn = document.getElementById('saveImageBtn');
  const addSubjectBtn = document.getElementById('addSubjectBtn');

  // Students editor elements
  const studentsList = document.getElementById('studentsList');
  const addStudentBtn = document.getElementById('addStudentBtn');
  const studentsPreviewBody = document.getElementById('studentsPreviewBody');
  const absentList = document.getElementById('absentList');

  // Teacher name elements
  const teacherNameInput = document.getElementById('teacherNameInput');
  const teacherNamePreview = document.getElementById('teacherNamePreview');

  function updateDate() {
    const d = new Date();
    dateFull.textContent = d.toLocaleDateString(undefined, { month:'short', day:'numeric', year:'numeric' });
    dateWeek.textContent = d.toLocaleDateString(undefined, { weekday:'long' });
  }
  updateDate();
  setInterval(updateDate, 60000);

  /* ---------- SUBJECTS FORM & PREVIEW ---------- */
  function renderForm() {
    subjectsList.innerHTML = '';
    subjects.forEach((s, idx) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'p-4 border rounded-lg bg-white shadow-sm';

      const top = document.createElement('div');
      top.className = 'flex items-start justify-between mb-3 gap-3';

      const nameInput = document.createElement('input');
      nameInput.className = 'w-full rounded-md border px-3 py-2 text-sm font-bold';
      nameInput.value = s.name;
      nameInput.addEventListener('input', (e) => {
        s.name = e.target.value;
        renderPreview();
      });

      const removeBtn = document.createElement('button');
      removeBtn.className = 'ml-2 px-2 py-1 text-red-500';
      removeBtn.innerHTML = 'ðŸ—‘';
      removeBtn.title = 'Remove subject';
      removeBtn.addEventListener('click', () => {
        subjects = subjects.filter(x => x.id !== s.id);
        renderForm();
        renderPreview();
      });

      top.appendChild(nameInput);
      top.appendChild(removeBtn);

      const textarea = document.createElement('textarea');
      textarea.className = 'w-full rounded-md border px-3 py-2 text-sm min-h-[80px]';
      textarea.placeholder = `Enter ${s.name} homework...`;
      textarea.value = s.content;
      textarea.addEventListener('input', (e) => {
        s.content = e.target.value;
        renderPreview();
      });

      wrapper.appendChild(top);
      wrapper.appendChild(textarea);
      subjectsList.appendChild(wrapper);
    });
  }

  function renderPreview(){
    classBadge.textContent = classInput.value + ' (' + sectionInput.value + ')';
    previewGrid.innerHTML = '';

    // teacher name preview
    teacherNamePreview.textContent = teacherNameInput.value || 'â€”';

    subjects.forEach((s, idx) => {
      const card = document.createElement('div');
      card.className = 'border rounded-xl overflow-hidden';

      const header = document.createElement('div');
      header.className = `${s.color} px-4 subject-header-tight flex items-center gap-2`;

      const iconWrap = document.createElement('div');
      iconWrap.className = 'p-1 bg-white/20 rounded-full';
      iconWrap.innerHTML = `<span class=\"text-white\">${s.icon}</span>`;

      const title = document.createElement('h3');
      title.className = 'font-bold text-white text-sm md:text-base';
      title.textContent = s.name;

      header.appendChild(iconWrap);
      header.appendChild(title);

      const body = document.createElement('div');
      body.className = `${s.light} p-3 min-h-[60px]`;
      const p = document.createElement('p');
      p.className = 'font-hand text-xl whitespace-pre-wrap';
      p.textContent = s.content || ' ';
      body.appendChild(p);

      card.appendChild(header);
      card.appendChild(body);
      previewGrid.appendChild(card);
    });

    renderStudentsPreview();
  }

  /* ---------- STUDENTS FORM & PREVIEW ---------- */
  function renderStudentsForm(){
    studentsList.innerHTML = '';
    students.forEach((st, idx) => {
      const row = document.createElement('div');
      row.className = 'p-3 border rounded-lg bg-white flex flex-col md:flex-row items-start md:items-center gap-3';

      const nameInput = document.createElement('input');
      nameInput.className = 'flex-1 rounded-md border px-3 py-2 text-sm';
      nameInput.value = st.name;
      nameInput.addEventListener('input', (e)=>{ st.name = e.target.value; renderStudentsPreview(); });

      const noCopiesInput = document.createElement('input');
      noCopiesInput.type = 'text';
      noCopiesInput.placeholder = 'e.g., Math, English';
      noCopiesInput.className = 'rounded-md border px-3 py-2 text-sm w-full md:w-56';
      noCopiesInput.value = st.noCopiesNote;
      noCopiesInput.addEventListener('input', (e)=>{ st.noCopiesNote = e.target.value; renderStudentsPreview(); });

      const noDiariesInput = document.createElement('input');
      noDiariesInput.type = 'text';
      noDiariesInput.placeholder = 'e.g., Diary missing or NO';
      noDiariesInput.className = 'rounded-md border px-3 py-2 text-sm w-full md:w-56';
      noDiariesInput.value = st.noDiariesNote;
      noDiariesInput.addEventListener('input', (e)=>{ st.noDiariesNote = e.target.value; renderStudentsPreview(); });

      const absent = document.createElement('input');
      absent.type = 'checkbox';
      absent.checked = st.absent;
      absent.title = 'Absent';
      absent.addEventListener('change', (e)=>{ 
        st.absent = e.target.checked; 
        // disable/clear notes when absent
        if (st.absent) {
          st.noCopiesNote = '';
          st.noDiariesNote = '';
        }
        renderStudentsForm();
        renderStudentsPreview(); 
      });

      const remove = document.createElement('button');
      remove.className = 'px-2 py-1 text-red-500';
      remove.innerText = 'Remove';
      remove.addEventListener('click', ()=>{ students.splice(idx,1); renderStudentsForm(); renderStudentsPreview(); });

      const controls = document.createElement('div');
      controls.className = 'flex items-center gap-2';
      const labelAbsent = document.createElement('label');
      labelAbsent.className = 'flex items-center gap-2 text-sm';
      labelAbsent.appendChild(absent);
      labelAbsent.appendChild(document.createTextNode('Absent'));
      controls.appendChild(labelAbsent);

      // if student is absent, hide/disable the noCopies and noDiaries inputs
      if (st.absent) {
        noCopiesInput.disabled = true;
        noCopiesInput.value = '';
        noCopiesInput.placeholder = 'â€”';
        noDiariesInput.disabled = true;
        noDiariesInput.value = '';
        noDiariesInput.placeholder = 'â€”';
      }

      // layout: name left, inputs + absent + remove right
      const right = document.createElement('div');
      right.className = 'flex items-center gap-2 w-full md:w-auto';
      right.appendChild(noCopiesInput);
      right.appendChild(noDiariesInput);
      right.appendChild(controls);
      right.appendChild(remove);

      row.appendChild(nameInput);
      row.appendChild(right);

      studentsList.appendChild(row);
    });
  }

  function renderStudentsPreview(){
    studentsPreviewBody.innerHTML = '';
    const absentNames = [];

    students.forEach((st)=>{
      if (st.absent) {
        absentNames.push(st.name);
        return; // skip absent students from main table
      }

      const tr = document.createElement('tr');

      const nameTd = document.createElement('td');
      nameTd.textContent = st.name;

      const noCopiesTd = document.createElement('td');
      noCopiesTd.textContent = st.noCopiesNote || '';

      const noDiariesTd = document.createElement('td');
      noDiariesTd.textContent = st.noDiariesNote || '';

      tr.appendChild(nameTd);
      tr.appendChild(noCopiesTd);
      tr.appendChild(noDiariesTd);

      studentsPreviewBody.appendChild(tr);
    });

    // render absent names in the right-side box
    absentList.innerHTML = '';
    if (absentNames.length === 0) return;
    absentList.innerHTML = absentNames.map(n => `<div>${n}</div>`).join('');
  }

  /* ---------- EVENTS ---------- */
  addSubjectBtn.addEventListener('click', () => {
    const i = subjects.length % palette.length;
    subjects.push({ id: 's' + Date.now(), name: 'New Subject', icon: 'ðŸ“˜', ...palette[i], content: '' });
    renderForm();
    renderPreview();
    setTimeout(()=> { subjectsList.lastChild.scrollIntoView({ behavior:'smooth', block:'center' }); }, 50);
  });

  addStudentBtn.addEventListener('click', ()=>{
    students.push({ id: 's' + Date.now(), name: 'New Student', noCopiesNote: '', noDiariesNote: '', absent: false });
    renderStudentsForm();
    renderStudentsPreview();
    setTimeout(()=> { studentsList.lastChild.scrollIntoView({ behavior:'smooth', block:'center' }); }, 50);
  });

  classInput.addEventListener('input', () => renderPreview());
  sectionInput.addEventListener('input', () => renderPreview());
  teacherNameInput.addEventListener('input', () => renderPreview());

  /* ---------- INITIAL RENDER ---------- */
  renderForm();
  renderStudentsForm();
  renderPreview();

  /* ---------- IMAGE EXPORT (html2canvas) ---------- */
  saveImageBtn.addEventListener('click', async () => {
    const original = document.getElementById('sheet');
    const clone = original.cloneNode(true);

    // Replace inputs & textareas & checkboxes with static text in the clone:
    const els = clone.querySelectorAll('input, textarea');
    els.forEach(el => {
      const tag = el.tagName.toLowerCase();
      const div = document.createElement('div');

      if (el.type === 'checkbox') {
        // remove checkboxes visually (absent names shown separately)
        div.textContent = '';
        div.style.minHeight = '1.4rem';
      } else {
        div.className = tag === 'textarea' ? 'clone-textarea-fallback' : '';
        div.textContent = el.value || '';
      }
      if (el.parentNode) el.parentNode.replaceChild(div, el);
    });

    // Normalize images if any (logo)
    const logos = clone.querySelectorAll('img');
    logos.forEach(img => {
      img.style.maxWidth = '100%';
      img.style.height = img.style.height || 'auto';
      img.style.borderRadius='50%';
    });

    // Append clone off-screen for capture
    clone.style.position = 'fixed';
    clone.style.left = '-10000px';
    clone.style.top = '0';
    document.body.appendChild(clone);

    try {
      const canvas = await html2canvas(clone, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
      const link = document.createElement('a');
      link.href = canvas.toDataURL('image/png');
      const d = new Date();
      link.download = `homework-${d.toISOString().split('T')[0]}.png`;
      link.click();
    } catch (err) {
      console.error('capture failed', err);
      alert('Image generation failed. See console.');
    } finally {
      document.body.removeChild(clone);
    }
  });

  // expose for debugging
  window.__krizma = { subjects, students, renderForm, renderStudentsForm, renderPreview };

})();
</script>
</body>
</html>
